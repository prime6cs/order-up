<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Main Page</title>
    <style>
  body {
    margin: 0;
    padding: 20px;
    font-family: Roboto, sans-serif;
  }
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
  }
  .queue-container {
    display: flex;
    gap: 60px;
  }
  .queue-box {
    text-align: center;
  }
  .queue-title {
    font-size: 16px;
  }
  .queue-number {
    font-size: 28px;
    font-weight: bold;
    margin-top: 5px;
  }
  .order-card {
    background: #f3f3f3;
    padding: 12px;
    margin: 12px 0;
    border-radius: 6px;
    font-family: monospace;
  }

  .order-row {
    display: grid;
    grid-template-columns: 220px 1fr;
    gap: 10px;
  }

  .order-row span:first-child {
    font-weight: bold;
  }
  #status {
    top: 30px;
    text-align: right;
    font-size: 18px;
  }
  #logout {
    position: fixed;
    top: 12px;
    right: 12px;
    padding: 8px 14px;
    cursor: pointer;
  }
  #order {
    white-space: pre-wrap;
    margin-top: 10px;
  }
</style>
  </head>
  <body>
    <div class="top-bar">
    <div class="queue-container">
      <div class="queue-box">
        <div class="queue-title">Total queue length</div>
        <div id="globalqueue" class="queue-number">-</div>
      </div>
      <div class="queue-box">
        <div class="queue-title">Your queue position</div>
        <div id="localqueue" class="queue-number">-</div>
      </div>
    </div>
    <h1 id="status">Please wait...</h1>
  </div>
  <h2 id="ordercount"></h2>
  <pre id="order"></pre>
  <button id="logout">Logout</button>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      const firebaseConfig = {
      apiKey: "AIzaSyB5h1wU1fc-UF540ZtCO3T2ubiDYiGXqIg",
      authDomain: "db-3dprint.firebaseapp.com",
      projectId: "db-3dprint",
      storageBucket: "db-3dprint.firebasestorage.app",
      messagingSenderId: "827838394950",
      appId: "1:827838394950:web:5e3e2618f765b2bfb41047"
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const status = document.getElementById("status");
      const oDiv = document.getElementById("order");
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          status.textContent = "Unauthorized. Please sign in.";
          return;
        }
        const email = user.email || "";
        // restrict access to 1 email domain only (you can change this/remove it)
        if (!email.endsWith("@tsis.ac.th")) {
          status.textContent = "Unauthorized email. Please logout and sign in with the correct email.";
          return;
        }
        status.textContent = "Checking for orders...";
        // you may want to change the db name here for the global order queue length
        const mainQueue = doc(db, "orders", "extra");
        const mainInfo = await getDoc(mainQueue);
        if (mainInfo.exists()) {
          const cur = mainInfo.data().globalQueueLength;
          document.getElementById("globalqueue").textContent = cur;
        }
        try {
          const q = query(collection(db, "orders"), where("Email Address", "==", email));
          const sn = await getDocs(q);
          if (!sn.empty) {
  oDiv.textContent = "";
  let minQueuePos = null;

  sn.docs.forEach((doc, idx) => {
    const info = doc.data();
    if (info.queue_pos !== undefined) {
      const qp = Number(info.queue_pos);
      if (!isNaN(qp) && (minQueuePos === null || qp < minQueuePos)) {
        minQueuePos = qp;
      }
    }
    let html = `
      <div class="order-card">
        <div><strong>Order No.${idx + 1} (${doc.id})</strong></div>
        <div>Status: ${info["ORDER STATUS"] ?? "-"}</div>
        <div>Timestamp: ${info["Timestamp"] ?? "-"}</div>
        <div>Order Total: ${info["TOTAL"] ?? "-"}</div>
        <hr>
    `;
    for (const key in info) {
      if (["ORDER STATUS", "ORDER ID", "Timestamp", "queue_pos", "TOTAL"].includes(key)) continue;
      html += `
        <div class="order-row">
          <span>${key}</span>
          <span>${info[key]}</span>
        </div>
      `;
    }
    html += `</div>`;
    oDiv.innerHTML += html;
  });
    document.getElementById("ordercount").textContent =
    `Found ${sn.size} order(s)`;

  if (minQueuePos !== null) {
    document.getElementById("localqueue").textContent = minQueuePos;
  } else {
    document.getElementById("localqueue").textContent = "-";
  }
          } else {
            status.textContent = "You currently have no orders";
          }
        } catch (e) {
          console.error(e);
          status.textContent = "Could not check for orders";
        }
      });
      document.getElementById("logout").onclick = async () => {
        await signOut(auth);
        window.location.href = "index.html";
      };
    </script>
  </body>
</html>
