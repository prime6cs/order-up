<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Main Page</title>
    <style>
      #logout {
        position: fixed;
        top: 12px;
        right: 12px;
        padding: 8px 14px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1 id="status">Please wait...</h1>
    <pre id="order" style="white-space: pre-wrap;"></pre>
    <h1 id="globalqueue"></h1>
    <p>Your current position in the queue: -</p>
    <button id="logout">Logout</button>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      const firebaseConfig = {
      apiKey: "AIzaSyB5h1wU1fc-UF540ZtCO3T2ubiDYiGXqIg",
      authDomain: "db-3dprint.firebaseapp.com",
      projectId: "db-3dprint",
      storageBucket: "db-3dprint.firebasestorage.app",
      messagingSenderId: "827838394950",
      appId: "1:827838394950:web:5e3e2618f765b2bfb41047"
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const status = document.getElementById("status");
      const oDiv = document.getElementById("order");
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          status.textContent = "Unauthorized. Please sign in.";
          return;
        }
        const email = user.email || "";
        // restrict access to 1 email domain only (you can change this/remove it)
        if (!email.endsWith("@tsis.ac.th")) {
          status.textContent = "Unauthorized email. Please logout and sign in with the correct email.";
          return;
        }
        status.textContent = "Checking for orders...";
        // you may want to change the db name here for the global order queue length
        const mainQueue = doc(db, "orders", "extra");
        const mainInfo = await getDoc(mainQueue);
        if (mainInfo.exists()) {
          const cur = mainInfo.data().globalQueueLength;
          document.getElementById("globalqueue").textContent = `Total queue length: ${cur} order(s)`;
        }
        try {
          const q = query(collection(db, "orders"), where("Email Address", "==", email));
          const sn = await getDocs(q);
          if (!sn.empty) {
            status.textContent = `Found ${sn.size} order(s):`;
            oDiv.textContent = "";
            sn.docs.forEach((doc, idx) => {
              const info = doc.data();
              oDiv.textContent += `Order No.${idx+1} (${doc.id})\n`+JSON.stringify(info,null,2)+"\n\n";
            });
          } else {
            status.textContent = "You currently have no orders";
          }
        } catch (e) {
          console.error(e);
          status.textContent = "Could not check for orders";
        }
      });
      document.getElementById("logout").onclick = async () => {
        await signOut(auth);
        window.location.href = "index.html";
      };
    </script>
  </body>
</html>
